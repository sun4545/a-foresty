const express = require('express');
const nodemailer = require('nodemailer');
const cors = require('cors');
const path = require('path');
const https = require('https');
const fs = require('fs');
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 8443;
const HOST = process.env.HOST || '192.168.0.15';
const SSL_KEY_PATH = process.env.SSL_KEY_PATH || path.join(__dirname, 'ssl', 'key.pem');
const SSL_CERT_PATH = process.env.SSL_CERT_PATH || path.join(__dirname, 'ssl', 'cert.pem');

// 미들웨어 설정
app.use(cors());
app.use(express.json());
app.use(express.static('.')); // 정적 파일 서빙

// 이메일 전송기 설정
const transporter = nodemailer.createTransport({
    service: 'gmail',
    auth: {
        user: process.env.EMAIL_USER || 'your-email@gmail.com',
        pass: process.env.EMAIL_PASS || 'your-app-password'
    }
});

// 구독자 목록 (실제로는 데이터베이스에 저장)
let subscribers = [];

// 구독 API 엔드포인트
app.post('/api/subscribe', async (req, res) => {
    try {
        const { email } = req.body;
        
        // 이메일 유효성 검사
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            return res.status(400).json({ 
                success: false, 
                message: '올바른 이메일 주소를 입력해주세요.' 
            });
        }
        
        // 중복 구독 체크
        if (subscribers.includes(email)) {
            return res.status(400).json({ 
                success: false, 
                message: '이미 구독된 이메일 주소입니다.' 
            });
        }
        
        // 구독자 목록에 추가
        subscribers.push(email);
        
        // 구독자에게 환영 이메일 발송
        const welcomeMailOptions = {
            from: process.env.EMAIL_USER || 'your-email@gmail.com',
            to: email,
            subject: '🎉 Technova Place 구독 완료!',
            html: `
                <div style="font-family: 'Hubot Sans', Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <svg width="165" height="24" viewBox="0 0 165 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="width: 200px; height: auto;">
                            <path d="M17.1429 9.02454H11.3345V2.85742H5.76807C5.76807 6.26443 3.18655 9.02454 0 9.02454V14.976H5.76807V21.1431H11.3345C11.3345 17.7361 13.9563 14.976 17.1429 14.976V9.02454Z" fill="#161616"/>
                            <path d="M25.7743 17.7144C25.1282 17.7144 24.6101 17.5559 24.22 17.2389C23.8421 16.922 23.6531 16.4222 23.6531 15.7395V5.18864H27.1274V15.0446H28.9743V17.7144H25.7743ZM22.0988 10.3452V7.82178H28.956V10.3452H22.0988ZM35.3358 17.9155C34.5069 17.9155 33.7511 17.8058 33.0684 17.5864C32.3979 17.3669 31.825 17.05 31.3496 16.6355C30.8741 16.221 30.5023 15.7212 30.2341 15.1361C29.9781 14.5387 29.8501 13.8744 29.8501 13.1429V12.3749C29.8501 11.3997 30.0757 10.5585 30.5267 9.8515C30.9899 9.14445 31.6299 8.59588 32.4467 8.20578C33.2635 7.81569 34.2265 7.62064 35.3358 7.62064C36.1526 7.62064 36.884 7.73035 37.5301 7.94978C38.1884 8.16921 38.7492 8.48616 39.2124 8.90064C39.6878 9.31512 40.0536 9.80883 40.3096 10.3818C40.5656 10.9547 40.6936 11.6008 40.6936 12.3201V13.6184H32.8856V11.7166H37.4021L37.1461 11.9909V11.4058C37.1461 11.101 37.073 10.8389 36.9267 10.6195C36.7804 10.4001 36.5732 10.2294 36.305 10.1075C36.0368 9.98559 35.7137 9.92464 35.3358 9.92464C34.9457 9.92464 34.6044 9.99169 34.3118 10.1258C34.0315 10.2477 33.812 10.4244 33.6536 10.6561C33.5073 10.8877 33.4341 11.162 33.4341 11.4789V14.0389C33.4341 14.3437 33.5134 14.618 33.6718 14.8618C33.8425 15.0934 34.068 15.2763 34.3484 15.4104C34.641 15.5445 34.9884 15.6115 35.3907 15.6115C35.8661 15.6115 36.2623 15.5262 36.5793 15.3555C36.8962 15.1726 37.0974 14.9227 37.1827 14.6058H40.6021C40.4924 15.2763 40.1937 15.8614 39.7061 16.3612C39.2307 16.861 38.6151 17.245 37.8593 17.5132C37.1157 17.7814 36.2745 17.9155 35.3358 17.9155ZM47.2461 17.9155C46.405 17.9155 45.6431 17.8058 44.9604 17.5864C44.2899 17.3547 43.717 17.0317 43.2416 16.6172C42.7783 16.2027 42.4187 15.7029 42.1627 15.1178C41.9067 14.5326 41.7787 13.8744 41.7787 13.1429V12.3749C41.7787 11.3997 42.0042 10.5585 42.4553 9.8515C42.9063 9.14445 43.5402 8.59588 44.357 8.20578C45.1859 7.81569 46.1551 7.62064 47.2644 7.62064C48.3128 7.62064 49.2149 7.78521 49.9707 8.11435C50.7387 8.43131 51.3421 8.88235 51.781 9.4675C52.2198 10.0526 52.4576 10.7353 52.4941 11.5155H49.0198C48.9711 11.0523 48.7943 10.7048 48.4896 10.4732C48.197 10.2416 47.7947 10.1258 47.2827 10.1258C46.8926 10.1258 46.5574 10.1928 46.277 10.3269C45.9966 10.461 45.7772 10.65 45.6187 10.8938C45.4724 11.1376 45.3993 11.418 45.3993 11.7349V13.7829C45.3993 14.0999 45.4724 14.3803 45.6187 14.6241C45.7772 14.8679 45.9966 15.0568 46.277 15.1909C46.5696 15.325 46.9109 15.3921 47.301 15.3921C47.6301 15.3921 47.9166 15.3433 48.1604 15.2458C48.4042 15.1361 48.5993 14.9776 48.7456 14.7704C48.8918 14.5509 48.9772 14.2949 49.0016 14.0024H52.5307C52.4819 14.7825 52.2259 15.4652 51.7627 16.0504C51.3117 16.6355 50.696 17.0926 49.9158 17.4218C49.1478 17.7509 48.2579 17.9155 47.2461 17.9155ZM53.6797 17.7144V4.38407H57.154V9.0835H57.282C57.6599 8.60807 58.1231 8.24845 58.6717 8.00464C59.2203 7.76083 59.8298 7.63893 60.5003 7.63893C61.317 7.63893 61.9997 7.79131 62.5483 8.09607C63.0968 8.40083 63.5113 8.83359 63.7917 9.39435C64.0721 9.94293 64.2123 10.6134 64.2123 11.4058V17.7144H60.7197V11.8995C60.7197 11.546 60.6587 11.2473 60.5368 11.0035C60.4271 10.7597 60.2504 10.5707 60.0066 10.4366C59.7749 10.3025 59.4763 10.2355 59.1106 10.2355C58.6839 10.2355 58.306 10.3269 57.9768 10.5098C57.6477 10.6804 57.3734 10.9182 57.154 11.2229V17.7144H53.6797ZM65.6797 17.7144V7.82178H68.77L69.154 9.0835H69.282C69.6599 8.60807 70.1231 8.24845 70.6717 8.00464C71.2203 7.76083 71.8298 7.63893 72.5003 7.63893C73.317 7.63893 73.9997 7.79131 74.5483 8.09607C75.0968 8.40083 75.5113 8.83359 75.7917 9.39435C76.0721 9.94293 76.2123 10.6134 76.2123 11.4058V17.7144H72.7197V11.8995C72.7197 11.546 72.6588 11.2473 72.5368 11.0035C72.4271 10.7597 72.2504 10.5707 72.0066 10.4366C71.7749 10.3025 71.4763 10.2355 71.1106 10.2355C70.6839 10.2355 70.306 10.3269 69.9768 10.5098C69.6477 10.6804 69.3734 10.9182 69.154 11.2229V17.7144H65.6797ZM82.9617 17.9155C82.1084 17.9155 81.3404 17.8058 80.6577 17.5864C79.9872 17.3547 79.4082 17.0317 78.9206 16.6172C78.4451 16.2027 78.0794 15.7029 77.8234 15.1178C77.5674 14.5326 77.4394 13.8744 77.4394 13.1429V12.3749C77.4394 11.4119 77.6649 10.5768 78.116 9.86978C78.567 9.15055 79.2009 8.59588 80.0177 8.20578C80.8467 7.81569 81.828 7.62064 82.9617 7.62064C83.815 7.62064 84.5769 7.73035 85.2474 7.94978C85.9179 8.16921 86.4908 8.49226 86.9663 8.91893C87.4539 9.3334 87.8257 9.83321 88.0817 10.4184C88.3377 10.9913 88.4657 11.6435 88.4657 12.3749V13.1429C88.4657 14.1182 88.2402 14.9654 87.7891 15.6846C87.3503 16.3917 86.7164 16.9403 85.8874 17.3304C85.0707 17.7205 84.0954 17.9155 82.9617 17.9155ZM82.9617 15.3921C83.3518 15.3921 83.687 15.325 83.9674 15.1909C84.2478 15.0568 84.4672 14.8679 84.6257 14.6241C84.7842 14.3803 84.8634 14.0999 84.8634 13.7829V11.7349C84.8634 11.418 84.7842 11.1376 84.6257 10.8938C84.4672 10.65 84.2478 10.461 83.9674 10.3269C83.687 10.1928 83.3518 10.1258 82.9617 10.1258C82.5716 10.1258 82.2303 10.1928 81.9377 10.3269C81.6573 10.461 81.4379 10.65 81.2794 10.8938C81.1331 11.1376 81.06 11.418 81.06 11.7349V13.7829C81.06 14.0999 81.1331 14.3803 81.2794 14.6241C81.4379 14.8679 81.6573 15.0568 81.9377 15.1909C82.2303 15.325 82.5716 15.3921 82.9617 15.3921ZM92.1446 17.7144L88.5423 7.82178H92.1446L93.9914 13.8012L94.284 15.0446H94.3937L94.668 13.8012L96.5331 7.82178H100.117L96.5514 17.7144H92.1446ZM104.558 17.8972C103.912 17.8972 103.327 17.7936 102.803 17.5864C102.278 17.3669 101.827 17.0622 101.449 16.6721C101.084 16.2698 100.797 15.8005 100.59 15.2641C100.395 14.7155 100.297 14.106 100.297 13.4355V12.0824C100.297 11.1925 100.468 10.4184 100.809 9.76007C101.163 9.08959 101.657 8.5715 102.291 8.20578C102.937 7.82788 103.692 7.63893 104.558 7.63893C105.241 7.63893 105.844 7.77302 106.368 8.04121C106.905 8.29721 107.295 8.63855 107.539 9.06521H107.667L108.014 7.82178H111.159V17.7144H108.014L107.667 16.4344H107.539C107.295 16.8854 106.905 17.245 106.368 17.5132C105.844 17.7692 105.241 17.8972 104.558 17.8972ZM105.838 15.3738C106.24 15.3738 106.6 15.2945 106.917 15.1361C107.246 14.9654 107.496 14.7399 107.667 14.4595V11.0584C107.496 10.778 107.246 10.5585 106.917 10.4001C106.6 10.2294 106.24 10.1441 105.838 10.1441C105.448 10.1441 105.107 10.2172 104.814 10.3635C104.521 10.5098 104.296 10.717 104.137 10.9852C103.979 11.2412 103.9 11.5582 103.9 11.9361V13.6001C103.9 13.9658 103.979 14.2827 104.137 14.5509C104.296 14.8191 104.521 15.0264 104.814 15.1726C105.107 15.3067 105.448 15.3738 105.838 15.3738ZM116.076 20.7681V7.96807H118.398L118.617 9.35778H118.727C119.007 8.87016 119.422 8.49226 119.97 8.22407C120.519 7.94369 121.153 7.8035 121.872 7.8035C122.506 7.8035 123.073 7.90712 123.573 8.11435C124.085 8.32159 124.517 8.61416 124.871 8.99207C125.237 9.36997 125.517 9.82712 125.712 10.3635C125.907 10.8877 126.005 11.4728 126.005 12.1189V13.5452C126.005 14.4107 125.834 15.1726 125.493 15.8309C125.164 16.477 124.688 16.9829 124.066 17.3486C123.445 17.7022 122.713 17.8789 121.872 17.8789C121.153 17.8789 120.519 17.7387 119.97 17.4584C119.422 17.178 119.007 16.8001 118.727 16.3246H118.617V20.7681H116.076ZM120.958 15.9772C121.445 15.9772 121.866 15.8919 122.22 15.7212C122.585 15.5384 122.866 15.2824 123.061 14.9532C123.268 14.6119 123.372 14.2157 123.372 13.7646V11.9178C123.372 11.4424 123.268 11.0401 123.061 10.7109C122.866 10.3818 122.585 10.1319 122.22 9.96121C121.866 9.77835 121.445 9.68693 120.958 9.68693C120.434 9.68693 119.964 9.80883 119.55 10.0526C119.148 10.2964 118.837 10.6439 118.617 11.0949V14.5875C118.837 15.0264 119.148 15.3677 119.55 15.6115C119.964 15.8553 120.434 15.9772 120.958 15.9772ZM127.504 17.7144V4.38407H130.046V17.7144H127.504ZM135.719 17.8789C135.073 17.8789 134.494 17.7753 133.982 17.5681C133.482 17.3608 133.049 17.0683 132.684 16.6904C132.318 16.3125 132.038 15.8553 131.843 15.3189C131.648 14.7825 131.55 14.1913 131.55 13.5452V12.1372C131.55 11.2717 131.721 10.5159 132.062 9.86978C132.403 9.2115 132.885 8.70559 133.507 8.35207C134.128 7.98635 134.866 7.8035 135.719 7.8035C136.414 7.8035 137.036 7.94369 137.584 8.22407C138.145 8.49226 138.56 8.87016 138.828 9.35778H138.937L139.175 7.96807H141.497V17.7144H139.175L138.937 16.3064H138.828C138.56 16.8062 138.145 17.1963 137.584 17.4766C137.036 17.7448 136.414 17.8789 135.719 17.8789ZM136.597 15.9772C137.133 15.9772 137.603 15.8553 138.005 15.6115C138.419 15.3677 138.73 15.0264 138.937 14.5875V11.0766C138.73 10.65 138.419 10.3147 138.005 10.0709C137.603 9.82712 137.133 9.70521 136.597 9.70521C136.109 9.70521 135.689 9.79664 135.335 9.9795C134.982 10.1502 134.701 10.4001 134.494 10.7292C134.299 11.0462 134.201 11.4424 134.201 11.9178V13.7646C134.201 14.2157 134.299 14.6119 134.494 14.9532C134.701 15.2945 134.982 15.5505 135.335 15.7212C135.689 15.8919 136.109 15.9772 136.597 15.9772ZM148.007 17.8972C147.227 17.8972 146.526 17.7936 145.904 17.5864C145.283 17.3669 144.752 17.0561 144.313 16.6538C143.875 16.2515 143.539 15.77 143.308 15.2092C143.076 14.6485 142.96 14.0206 142.96 13.3258V12.3384C142.96 11.3997 143.168 10.5951 143.582 9.92464C143.996 9.24197 144.582 8.71778 145.337 8.35207C146.105 7.97416 147.001 7.78521 148.025 7.78521C148.964 7.78521 149.781 7.93759 150.476 8.24235C151.171 8.53493 151.719 8.9555 152.121 9.50407C152.536 10.0404 152.774 10.6683 152.835 11.3875H150.256C150.183 10.8145 149.945 10.3879 149.543 10.1075C149.153 9.82712 148.647 9.68693 148.025 9.68693C147.538 9.68693 147.111 9.77835 146.745 9.96121C146.38 10.1319 146.093 10.3757 145.886 10.6926C145.691 11.0096 145.593 11.3814 145.593 11.8081V13.8744C145.593 14.2888 145.691 14.6606 145.886 14.9898C146.093 15.3067 146.38 15.5566 146.745 15.7395C147.111 15.9102 147.544 15.9955 148.044 15.9955C148.458 15.9955 148.818 15.9345 149.123 15.8126C149.44 15.6785 149.696 15.4835 149.891 15.2275C150.086 14.9593 150.208 14.6363 150.256 14.2584H152.853C152.792 14.9898 152.548 15.6298 152.121 16.1784C151.695 16.7147 151.128 17.1353 150.421 17.4401C149.726 17.7448 148.921 17.8972 148.007 17.8972ZM159.025 17.8972C158.257 17.8972 157.556 17.7936 156.923 17.5864C156.301 17.3669 155.771 17.0622 155.332 16.6721C154.893 16.2698 154.552 15.7883 154.308 15.2275C154.076 14.6667 153.96 14.0328 153.96 13.3258V12.3384C153.96 11.3997 154.168 10.5951 154.582 9.92464C154.996 9.24197 155.582 8.71778 156.337 8.35207C157.105 7.97416 158.001 7.78521 159.025 7.78521C159.769 7.78521 160.44 7.89493 161.037 8.11435C161.646 8.32159 162.164 8.62026 162.591 9.01035C163.018 9.40045 163.347 9.87588 163.579 10.4366C163.81 10.9852 163.926 11.6008 163.926 12.2835V13.4721H156.173V11.9361H161.567L161.329 12.2286V11.5886C161.329 11.1742 161.232 10.8206 161.037 10.5281C160.854 10.2233 160.592 9.99169 160.251 9.83321C159.909 9.66255 159.501 9.57721 159.025 9.57721C158.526 9.57721 158.093 9.66864 157.727 9.8515C157.361 10.0222 157.081 10.266 156.886 10.5829C156.691 10.8877 156.593 11.2473 156.593 11.6618V14.0024C156.593 14.4168 156.691 14.7825 156.886 15.0995C157.093 15.4165 157.38 15.6603 157.745 15.8309C158.123 16.0016 158.562 16.0869 159.062 16.0869C159.672 16.0869 160.171 15.9711 160.561 15.7395C160.964 15.4957 161.22 15.1605 161.329 14.7338H163.835C163.725 15.3921 163.451 15.9589 163.012 16.4344C162.573 16.8976 162.012 17.2572 161.329 17.5132C160.647 17.7692 159.879 17.8972 159.025 17.8972Z" fill="#161616"/>
                        </svg>
                    </div>
                    
                    <h1 style="color: #161616; font-size: 28px; margin-bottom: 20px; text-align: center;">
                        구독해주셔서 감사합니다! 🙏
                    </h1>
                    
                    <p style="color: #161616; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
                        안녕하세요! <strong>${email}</strong>님,<br>
                        Technova Place 구독이 성공적으로 완료되었습니다.
                    </p>
                    
                    <div style="background: linear-gradient(135deg, #4F4FFF 0%, #6B6BFF 100%); padding: 30px; border-radius: 12px; margin: 30px 0;">
                        <h2 style="color: white; font-size: 20px; margin-bottom: 15px;">
                            🚀 앞으로 받으실 콘텐츠
                        </h2>
                        <ul style="color: white; font-size: 14px; line-height: 1.8;">
                            <li>AI & Machine Learning 최신 트렌드</li>
                            <li>클라우드 컴퓨팅 기술 인사이트</li>
                            <li>사이버보안 전문 지식</li>
                            <li>데이터 분석 실무 노하우</li>
                            <li>기술 커뮤니티 소식</li>
                        </ul>
                    </div>
                    
                    <p style="color: #666; font-size: 14px; line-height: 1.6; margin-top: 30px;">
                        언제든지 구독을 해지하실 수 있습니다.<br>
                        문의사항이 있으시면 언제든 연락주세요.
                    </p>
                    
                    <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                        <p style="color: #999; font-size: 12px;">
                            © 2025 Technova Inc. All Rights Reserved.
                        </p>
                    </div>
                </div>
            `
        };
        
        // 관리자에게 알림 이메일 발송
        const adminMailOptions = {
            from: process.env.EMAIL_USER || 'your-email@gmail.com',
            to: process.env.ADMIN_EMAIL || 'admin@technova.com',
            subject: '📧 새로운 구독자 등록',
            html: `
                <div style="font-family: Arial, sans-serif; max-width: 500px; margin: 0 auto; padding: 20px;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <svg width="165" height="24" viewBox="0 0 165 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="width: 200px; height: auto;">
                            <path d="M17.1429 9.02454H11.3345V2.85742H5.76807C5.76807 6.26443 3.18655 9.02454 0 9.02454V14.976H5.76807V21.1431H11.3345C11.3345 17.7361 13.9563 14.976 17.1429 14.976V9.02454Z" fill="#161616"/>
                            <path d="M25.7743 17.7144C25.1282 17.7144 24.6101 17.5559 24.22 17.2389C23.8421 16.922 23.6531 16.4222 23.6531 15.7395V5.18864H27.1274V15.0446H28.9743V17.7144H25.7743ZM22.0988 10.3452V7.82178H28.956V10.3452H22.0988ZM35.3358 17.9155C34.5069 17.9155 33.7511 17.8058 33.0684 17.5864C32.3979 17.3669 31.825 17.05 31.3496 16.6355C30.8741 16.221 30.5023 15.7212 30.2341 15.1361C29.9781 14.5387 29.8501 13.8744 29.8501 13.1429V12.3749C29.8501 11.3997 30.0757 10.5585 30.5267 9.8515C30.9899 9.14445 31.6299 8.59588 32.4467 8.20578C33.2635 7.81569 34.2265 7.62064 35.3358 7.62064C36.1526 7.62064 36.884 7.73035 37.5301 7.94978C38.1884 8.16921 38.7492 8.48616 39.2124 8.90064C39.6878 9.31512 40.0536 9.80883 40.3096 10.3818C40.5656 10.9547 40.6936 11.6008 40.6936 12.3201V13.6184H32.8856V11.7166H37.4021L37.1461 11.9909V11.4058C37.1461 11.101 37.073 10.8389 36.9267 10.6195C36.7804 10.4001 36.5732 10.2294 36.305 10.1075C36.0368 9.98559 35.7137 9.92464 35.3358 9.92464C34.9457 9.92464 34.6044 9.99169 34.3118 10.1258C34.0315 10.2477 33.812 10.4244 33.6536 10.6561C33.5073 10.8877 33.4341 11.162 33.4341 11.4789V14.0389C33.4341 14.3437 33.5134 14.618 33.6718 14.8618C33.8425 15.0934 34.068 15.2763 34.3484 15.4104C34.641 15.5445 34.9884 15.6115 35.3907 15.6115C35.8661 15.6115 36.2623 15.5262 36.5793 15.3555C36.8962 15.1726 37.0974 14.9227 37.1827 14.6058H40.6021C40.4924 15.2763 40.1937 15.8614 39.7061 16.3612C39.2307 16.861 38.6151 17.245 37.8593 17.5132C37.1157 17.7814 36.2745 17.9155 35.3358 17.9155ZM47.2461 17.9155C46.405 17.9155 45.6431 17.8058 44.9604 17.5864C44.2899 17.3547 43.717 17.0317 43.2416 16.6172C42.7783 16.2027 42.4187 15.7029 42.1627 15.1178C41.9067 14.5326 41.7787 13.8744 41.7787 13.1429V12.3749C41.7787 11.3997 42.0042 10.5585 42.4553 9.8515C42.9063 9.14445 43.5402 8.59588 44.357 8.20578C45.1859 7.81569 46.1551 7.62064 47.2644 7.62064C48.3128 7.62064 49.2149 7.78521 49.9707 8.11435C50.7387 8.43131 51.3421 8.88235 51.781 9.4675C52.2198 10.0526 52.4576 10.7353 52.4941 11.5155H49.0198C48.9711 11.0523 48.7943 10.7048 48.4896 10.4732C48.197 10.2416 47.7947 10.1258 47.2827 10.1258C46.8926 10.1258 46.5574 10.1928 46.277 10.3269C45.9966 10.461 45.7772 10.65 45.6187 10.8938C45.4724 11.1376 45.3993 11.418 45.3993 11.7349V13.7829C45.3993 14.0999 45.4724 14.3803 45.6187 14.6241C45.7772 14.8679 45.9966 15.0568 46.277 15.1909C46.5696 15.325 46.9109 15.3921 47.301 15.3921C47.6301 15.3921 47.9166 15.3433 48.1604 15.2458C48.4042 15.1361 48.5993 14.9776 48.7456 14.7704C48.8918 14.5509 48.9772 14.2949 49.0016 14.0024H52.5307C52.4819 14.7825 52.2259 15.4652 51.7627 16.0504C51.3117 16.6355 50.696 17.0926 49.9158 17.4218C49.1478 17.7509 48.2579 17.9155 47.2461 17.9155ZM53.6797 17.7144V4.38407H57.154V9.0835H57.282C57.6599 8.60807 58.1231 8.24845 58.6717 8.00464C59.2203 7.76083 59.8298 7.63893 60.5003 7.63893C61.317 7.63893 61.9997 7.79131 62.5483 8.09607C63.0968 8.40083 63.5113 8.83359 63.7917 9.39435C64.0721 9.94293 64.2123 10.6134 64.2123 11.4058V17.7144H60.7197V11.8995C60.7197 11.546 60.6587 11.2473 60.5368 11.0035C60.4271 10.7597 60.2504 10.5707 60.0066 10.4366C59.7749 10.3025 59.4763 10.2355 59.1106 10.2355C58.6839 10.2355 58.306 10.3269 57.9768 10.5098C57.6477 10.6804 57.3734 10.9182 57.154 11.2229V17.7144H53.6797ZM65.6797 17.7144V7.82178H68.77L69.154 9.0835H69.282C69.6599 8.60807 70.1231 8.24845 70.6717 8.00464C71.2203 7.76083 71.8298 7.63893 72.5003 7.63893C73.317 7.63893 73.9997 7.79131 74.5483 8.09607C75.0968 8.40083 75.5113 8.83359 75.7917 9.39435C76.0721 9.94293 76.2123 10.6134 76.2123 11.4058V17.7144H72.7197V11.8995C72.7197 11.546 72.6588 11.2473 72.5368 11.0035C72.4271 10.7597 72.2504 10.5707 72.0066 10.4366C71.7749 10.3025 71.4763 10.2355 71.1106 10.2355C70.6839 10.2355 70.306 10.3269 69.9768 10.5098C69.6477 10.6804 69.3734 10.9182 69.154 11.2229V17.7144H65.6797ZM82.9617 17.9155C82.1084 17.9155 81.3404 17.8058 80.6577 17.5864C79.9872 17.3547 79.4082 17.0317 78.9206 16.6172C78.4451 16.2027 78.0794 15.7029 77.8234 15.1178C77.5674 14.5326 77.4394 13.8744 77.4394 13.1429V12.3749C77.4394 11.4119 77.6649 10.5768 78.116 9.86978C78.567 9.15055 79.2009 8.59588 80.0177 8.20578C80.8467 7.81569 81.828 7.62064 82.9617 7.62064C83.815 7.62064 84.5769 7.73035 85.2474 7.94978C85.9179 8.16921 86.4908 8.49226 86.9663 8.91893C87.4539 9.3334 87.8257 9.83321 88.0817 10.4184C88.3377 10.9913 88.4657 11.6435 88.4657 12.3749V13.1429C88.4657 14.1182 88.2402 14.9654 87.7891 15.6846C87.3503 16.3917 86.7164 16.9403 85.8874 17.3304C85.0707 17.7205 84.0954 17.9155 82.9617 17.9155ZM82.9617 15.3921C83.3518 15.3921 83.687 15.325 83.9674 15.1909C84.2478 15.0568 84.4672 14.8679 84.6257 14.6241C84.7842 14.3803 84.8634 14.0999 84.8634 13.7829V11.7349C84.8634 11.418 84.7842 11.1376 84.6257 10.8938C84.4672 10.65 84.2478 10.461 83.9674 10.3269C83.687 10.1928 83.3518 10.1258 82.9617 10.1258C82.5716 10.1258 82.2303 10.1928 81.9377 10.3269C81.6573 10.461 81.4379 10.65 81.2794 10.8938C81.1331 11.1376 81.06 11.418 81.06 11.7349V13.7829C81.06 14.0999 81.1331 14.3803 81.2794 14.6241C81.4379 14.8679 81.6573 15.0568 81.9377 15.1909C82.2303 15.325 82.5716 15.3921 82.9617 15.3921ZM92.1446 17.7144L88.5423 7.82178H92.1446L93.9914 13.8012L94.284 15.0446H94.3937L94.668 13.8012L96.5331 7.82178H100.117L96.5514 17.7144H92.1446ZM104.558 17.8972C103.912 17.8972 103.327 17.7936 102.803 17.5864C102.278 17.3669 101.827 17.0622 101.449 16.6721C101.084 16.2698 100.797 15.8005 100.59 15.2641C100.395 14.7155 100.297 14.106 100.297 13.4355V12.0824C100.297 11.1925 100.468 10.4184 100.809 9.76007C101.163 9.08959 101.657 8.5715 102.291 8.20578C102.937 7.82788 103.692 7.63893 104.558 7.63893C105.241 7.63893 105.844 7.77302 106.368 8.04121C106.905 8.29721 107.295 8.63855 107.539 9.06521H107.667L108.014 7.82178H111.159V17.7144H108.014L107.667 16.4344H107.539C107.295 16.8854 106.905 17.245 106.368 17.5132C105.844 17.7692 105.241 17.8972 104.558 17.8972ZM105.838 15.3738C106.24 15.3738 106.6 15.2945 106.917 15.1361C107.246 14.9654 107.496 14.7399 107.667 14.4595V11.0584C107.496 10.778 107.246 10.5585 106.917 10.4001C106.6 10.2294 106.24 10.1441 105.838 10.1441C105.448 10.1441 105.107 10.2172 104.814 10.3635C104.521 10.5098 104.296 10.717 104.137 10.9852C103.979 11.2412 103.9 11.5582 103.9 11.9361V13.6001C103.9 13.9658 103.979 14.2827 104.137 14.5509C104.296 14.8191 104.521 15.0264 104.814 15.1726C105.107 15.3067 105.448 15.3738 105.838 15.3738ZM116.076 20.7681V7.96807H118.398L118.617 9.35778H118.727C119.007 8.87016 119.422 8.49226 119.97 8.22407C120.519 7.94369 121.153 7.8035 121.872 7.8035C122.506 7.8035 123.073 7.90712 123.573 8.11435C124.085 8.32159 124.517 8.61416 124.871 8.99207C125.237 9.36997 125.517 9.82712 125.712 10.3635C125.907 10.8877 126.005 11.4728 126.005 12.1189V13.5452C126.005 14.4107 125.834 15.1726 125.493 15.8309C125.164 16.477 124.688 16.9829 124.066 17.3486C123.445 17.7022 122.713 17.8789 121.872 17.8789C121.153 17.8789 120.519 17.7387 119.97 17.4584C119.422 17.178 119.007 16.8001 118.727 16.3246H118.617V20.7681H116.076ZM120.958 15.9772C121.445 15.9772 121.866 15.8919 122.22 15.7212C122.585 15.5384 122.866 15.2824 123.061 14.9532C123.268 14.6119 123.372 14.2157 123.372 13.7646V11.9178C123.372 11.4424 123.268 11.0401 123.061 10.7109C122.866 10.3818 122.585 10.1319 122.22 9.96121C121.866 9.77835 121.445 9.68693 120.958 9.68693C120.434 9.68693 119.964 9.80883 119.55 10.0526C119.148 10.2964 118.837 10.6439 118.617 11.0949V14.5875C118.837 15.0264 119.148 15.3677 119.55 15.6115C119.964 15.8553 120.434 15.9772 120.958 15.9772ZM127.504 17.7144V4.38407H130.046V17.7144H127.504ZM135.719 17.8789C135.073 17.8789 134.494 17.7753 133.982 17.5681C133.482 17.3608 133.049 17.0683 132.684 16.6904C132.318 16.3125 132.038 15.8553 131.843 15.3189C131.648 14.7825 131.55 14.1913 131.55 13.5452V12.1372C131.55 11.2717 131.721 10.5159 132.062 9.86978C132.403 9.2115 132.885 8.70559 133.507 8.35207C134.128 7.98635 134.866 7.8035 135.719 7.8035C136.414 7.8035 137.036 7.94369 137.584 8.22407C138.145 8.49226 138.56 8.87016 138.828 9.35778H138.937L139.175 7.96807H141.497V17.7144H139.175L138.937 16.3064H138.828C138.56 16.8062 138.145 17.1963 137.584 17.4766C137.036 17.7448 136.414 17.8789 135.719 17.8789ZM136.597 15.9772C137.133 15.9772 137.603 15.8553 138.005 15.6115C138.419 15.3677 138.73 15.0264 138.937 14.5875V11.0766C138.73 10.65 138.419 10.3147 138.005 10.0709C137.603 9.82712 137.133 9.70521 136.597 9.70521C136.109 9.70521 135.689 9.79664 135.335 9.9795C134.982 10.1502 134.701 10.4001 134.494 10.7292C134.299 11.0462 134.201 11.4424 134.201 11.9178V13.7646C134.201 14.2157 134.299 14.6119 134.494 14.9532C134.701 15.2945 134.982 15.5505 135.335 15.7212C135.689 15.8919 136.109 15.9772 136.597 15.9772ZM148.007 17.8972C147.227 17.8972 146.526 17.7936 145.904 17.5864C145.283 17.3669 144.752 17.0561 144.313 16.6538C143.875 16.2515 143.539 15.77 143.308 15.2092C143.076 14.6485 142.96 14.0206 142.96 13.3258V12.3384C142.96 11.3997 143.168 10.5951 143.582 9.92464C143.996 9.24197 144.582 8.71778 145.337 8.35207C146.105 7.97416 147.001 7.78521 148.025 7.78521C148.964 7.78521 149.781 7.93759 150.476 8.24235C151.171 8.53493 151.719 8.9555 152.121 9.50407C152.536 10.0404 152.774 10.6683 152.835 11.3875H150.256C150.183 10.8145 149.945 10.3879 149.543 10.1075C149.153 9.82712 148.647 9.68693 148.025 9.68693C147.538 9.68693 147.111 9.77835 146.745 9.96121C146.38 10.1319 146.093 10.3757 145.886 10.6926C145.691 11.0096 145.593 11.3814 145.593 11.8081V13.8744C145.593 14.2888 145.691 14.6606 145.886 14.9898C146.093 15.3067 146.38 15.5566 146.745 15.7395C147.111 15.9102 147.544 15.9955 148.044 15.9955C148.458 15.9955 148.818 15.9345 149.123 15.8126C149.44 15.6785 149.696 15.4835 149.891 15.2275C150.086 14.9593 150.208 14.6363 150.256 14.2584H152.853C152.792 14.9898 152.548 15.6298 152.121 16.1784C151.695 16.7147 151.128 17.1353 150.421 17.4401C149.726 17.7448 148.921 17.8972 148.007 17.8972ZM159.025 17.8972C158.257 17.8972 157.556 17.7936 156.923 17.5864C156.301 17.3669 155.771 17.0622 155.332 16.6721C154.893 16.2698 154.552 15.7883 154.308 15.2275C154.076 14.6667 153.96 14.0328 153.96 13.3258V12.3384C153.96 11.3997 154.168 10.5951 154.582 9.92464C154.996 9.24197 155.582 8.71778 156.337 8.35207C157.105 7.97416 158.001 7.78521 159.025 7.78521C159.769 7.78521 160.44 7.89493 161.037 8.11435C161.646 8.32159 162.164 8.62026 162.591 9.01035C163.018 9.40045 163.347 9.87588 163.579 10.4366C163.81 10.9852 163.926 11.6008 163.926 12.2835V13.4721H156.173V11.9361H161.567L161.329 12.2286V11.5886C161.329 11.1742 161.232 10.8206 161.037 10.5281C160.854 10.2233 160.592 9.99169 160.251 9.83321C159.909 9.66255 159.501 9.57721 159.025 9.57721C158.526 9.57721 158.093 9.66864 157.727 9.8515C157.361 10.0222 157.081 10.266 156.886 10.5829C156.691 10.8877 156.593 11.2473 156.593 11.6618V14.0024C156.593 14.4168 156.691 14.7825 156.886 15.0995C157.093 15.4165 157.38 15.6603 157.745 15.8309C158.123 16.0016 158.562 16.0869 159.062 16.0869C159.672 16.0869 160.171 15.9711 160.561 15.7395C160.964 15.4957 161.22 15.1605 161.329 14.7338H163.835C163.725 15.3921 163.451 15.9589 163.012 16.4344C162.573 16.8976 162.012 17.2572 161.329 17.5132C160.647 17.7692 159.879 17.8972 159.025 17.8972Z" fill="#161616"/>
                        </svg>
                    </div>
                    <h2 style="color: #161616;">새로운 구독자 등록</h2>
                    <p><strong>이메일:</strong> ${email}</p>
                    <p><strong>구독 시간:</strong> ${new Date().toLocaleString('ko-KR')}</p>
                    <p><strong>총 구독자 수:</strong> ${subscribers.length}명</p>
                </div>
            `
        };
        
        // 이메일 발송
        await transporter.sendMail(welcomeMailOptions);
        await transporter.sendMail(adminMailOptions);
        
        console.log(`✅ 새로운 구독자 등록: ${email}`);
        
        res.json({ 
            success: true, 
            message: '구독이 완료되었습니다! 환영 이메일을 확인해주세요.' 
        });
        
    } catch (error) {
        console.error('❌ 구독 처리 오류:', error);
        res.status(500).json({ 
            success: false, 
            message: '구독 처리 중 오류가 발생했습니다. 다시 시도해주세요.' 
        });
    }
});

// 구독자 목록 조회 API (관리자용)
app.get('/api/subscribers', (req, res) => {
    res.json({ 
        success: true, 
        subscribers: subscribers,
        count: subscribers.length 
    });
});

// 구독 해지 API
app.post('/api/unsubscribe', async (req, res) => {
    try {
        const { email } = req.body;
        
        const index = subscribers.indexOf(email);
        if (index > -1) {
            subscribers.splice(index, 1);
            
            // 구독 해지 확인 이메일 발송
            const unsubscribeMailOptions = {
                from: process.env.EMAIL_USER || 'your-email@gmail.com',
                to: email,
                subject: '구독 해지 완료',
                html: `
                    <div style="font-family: Arial, sans-serif; max-width: 500px; margin: 0 auto; padding: 20px;">
                        <h2>구독 해지 완료</h2>
                        <p>${email}님의 구독이 해지되었습니다.</p>
                        <p>다시 구독하고 싶으시면 언제든지 방문해주세요.</p>
                    </div>
                `
            };
            
            await transporter.sendMail(unsubscribeMailOptions);
            
            res.json({ 
                success: true, 
                message: '구독이 해지되었습니다.' 
            });
        } else {
            res.status(404).json({ 
                success: false, 
                message: '구독되지 않은 이메일 주소입니다.' 
            });
        }
    } catch (error) {
        console.error('구독 해지 오류:', error);
        res.status(500).json({ 
            success: false, 
            message: '구독 해지 중 오류가 발생했습니다.' 
        });
    }
});

// 서버 상태 확인
app.get('/api/health', (req, res) => {
    res.json({ 
        status: 'OK', 
        timestamp: new Date().toISOString(),
        subscribers: subscribers.length 
    });
});

// 메인 페이지 라우트
app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'index.html'));
});

// HTTPS 서버 시작
let sslOptions;
try {
    sslOptions = {
        key: fs.readFileSync(SSL_KEY_PATH),
        cert: fs.readFileSync(SSL_CERT_PATH)
    };
} catch (e) {
    console.error('❌ SSL 키/인증서 로드 실패:', e.message);
    console.error('ssl/key.pem, ssl/cert.pem 경로를 확인하세요. 임시로 HTTP로 동작합니다.');
}

if (sslOptions) {
    https.createServer(sslOptions, app).listen(PORT, HOST, () => {
        console.log(`🔐 HTTPS 서버가 https://${HOST}:${PORT} 에서 실행 중입니다.`);
        console.log(`📧 구독 API: https://${HOST}:${PORT}/api/subscribe`);
        console.log(`👥 구독자 수: ${subscribers.length}명`);
    });
} else {
    app.listen(PORT, HOST, () => {
        console.log(`⚠️  SSL 미적용 - HTTP 서버가 http://${HOST}:${PORT} 에서 실행 중입니다.`);
        console.log(`📧 구독 API: http://${HOST}:${PORT}/api/subscribe`);
        console.log(`👥 구독자 수: ${subscribers.length}명`);
    });
}
